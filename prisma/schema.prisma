// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id         Int      @id @default(autoincrement())
  employeeId String   @unique
  name       String
  email      String   @unique
  password   String  
  departmentId Int
  department    Department  @relation(fields: [departmentId], references: [departmentId])
  role       Role     @default(USER)
  action     Action   @default(PENDING)
  labs Lab[]          @relation("CustodianLabs")
  createdAt  DateTime @default(now())
  assignedLabs AssignedLab[]

  assignedItems  Items[]  @relation("AssignedByUser")
  transferedItems Items[] @relation("TransferedByUser")
}

model Lab {
  labId          Int           @id  @unique @default(autoincrement())
  labNumber      Int?    
  labName        String?
  custodianName  String?
  createdAt      DateTime      @default(now())
  custodianId    String?  
  custodian      User?         @relation("CustodianLabs", fields: [custodianId], references: [email])
  departmentId   Int
  department     Department    @relation(fields: [departmentId], references: [departmentId])
  assignedLabs   AssignedLab[] 
  items          Items[]
  fromTransfers TransferRequest[] @relation("FromLabTransfer")
  toTransfers   TransferRequest[] @relation("ToLabTransfer")
}   

model Department {
  departmentId Int @id @unique @default(autoincrement())
  department_Name String @unique
  labs    Lab[]
  users  User[]
  createdAt DateTime @default(now())
  items          Items[]
  fromTransfers TransferRequest[] @relation("FromDeptTransfer")
  toTransfers   TransferRequest[] @relation("ToDeptTransfer")
}

model AssignedLab {
  id     Int  @id @default(autoincrement())
  user   User @relation(fields: [email], references: [email])
  email  String
  lab    Lab  @relation(fields: [labId], references: [labId])
  labId  Int
  @@unique([email, labId]) 
}

enum Action {
  PENDING
  REJECTED
   TRANSFER_REQUESTS
  DELETE_REQUESTS
  APPROVED
}

enum Role {
  ADMIN
  USER
  CUSTODIAN
}

enum Activety {
  DELETE
  UPDATE
  TRANSFER
 
  ADDED
}

model Items {
  id               Int               @id @default(autoincrement())
  departmentId     Int 
  labId            Int
  assignedUserId   Int?
  custodianName    String
  quantity         Int?              @default(1)
  deviceNumber     String?
  deviceType       String
  dateNow          DateTime          @default(now())
  dateTill         DateTime?
  updatedAt        DateTime          @default(now()) @updatedAt
  department       Department        @relation(fields: [departmentId],references: [departmentId])
  lab              Lab               @relation(fields:[labId],references: [labId])
  transferedUserId Int?
  assignedBy      User?   @relation("AssignedByUser", fields: [assignedUserId], references: [id])
  transferedBy     User?            @relation("TransferedByUser", fields: [transferedUserId], references: [id]) 
  status           Action            @default(PENDING)
  activety         Activety          @default(ADDED)
  transferRequests TransferRequest[]
  @@map("items")
}

model TransferRequest {
  id             Int   @id @default(autoincrement())
  itemId         Int
  item           Items    @relation(fields: [itemId], references: [id])
  fromLabId      Int
  fromLab        Lab      @relation("FromLabTransfer", fields: [fromLabId], references: [labId])
  toLabId        Int
  toLab          Lab      @relation("ToLabTransfer", fields: [toLabId], references: [labId])
  fromDeptId     Int
  fromDepartment Department @relation("FromDeptTransfer", fields: [fromDeptId], references: [departmentId])
  toDeptId       Int
  toDepartment   Department @relation("ToDeptTransfer", fields: [toDeptId], references: [departmentId])
  quantity       Int
  status         Action   @default(PENDING) 
  activety       Activety @default(TRANSFER)
  requestedBy    String? // Add who requested the transfer
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt
  
  @@map("transfer_requests")
}


